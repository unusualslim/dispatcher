<!DOCTYPE html>
<html>
<head>
  <title>Production Orders – Kanban</title>
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <%= stylesheet_link_tag 'application', media: 'all' %>
  <%= javascript_include_tag 'application', 'data-turbo-track': 'reload', defer: true %>

  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f4f4f9;
      margin: 0;
      padding: 0;
    }

    /* ===== Top Bar ===== */
    .kanban-topbar {
      max-width: 1200px;
      margin: 1rem auto 0.25rem auto;
      padding: 0 0.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .kanban-title h1 {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0;
      color: #222;
    }

    .kanban-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* ===== Status Legend ===== */
    .status-legend {
      max-width: 1200px;
      margin: 0 auto 0.75rem auto;
      padding: 0 0.25rem;
      display: flex;
      gap: 1rem;
      font-size: 0.8rem;
      color: #555;
    }

    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 3px;
      margin-right: 4px;
      vertical-align: middle;
    }

    /* Status colors */
    .status-pending     { background: #6c757d; } /* gray */
    .status-in_progress { background: #ffc107; } /* amber */
    .status-completed   { background: #28a745; } /* green */


    /* ===== Filters ===== */
    .kanban-controls {
      max-width: 1200px;
      margin: 0 auto 0.75rem auto;
      padding: 0.75rem;
      background-color: #ffffff;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .form-group {
      flex: 1 1 160px;
      min-width: 140px;
    }

    .form-control {
      width: 100%;
      padding: 0.45rem 0.5rem;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    /* ===== Kanban Board ===== */
    .kanban-board {
      display: flex;
      padding: 0.75rem;
      gap: 0.75rem;
      overflow-x: auto;
    }

    .kanban-column {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 0.75rem;
      min-width: 220px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .kanban-column h2 {
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
      color: #333;
      display: flex;
      justify-content: space-between;
    }

    .kanban-cards {
      min-height: 150px;
    }

    .kanban-card {
      background-color: #ffffff;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 0.6rem;
      margin-bottom: 0.5rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
      text-decoration: none;
      color: inherit;
      display: block;
      position: relative;
    }

    .kanban-card:hover {
      box-shadow: 0 3px 6px rgba(0,0,0,0.12);
    }

    .status-bar {
      height: 4px;
      width: 100%;
      border-radius: 6px 6px 0 0;
      position: absolute;
      top: 0;
      left: 0;
    }

    .kanban-card h4 {
      font-size: 0.85rem;
      margin: 0.35rem 0 0.25rem 0;
      color: #007bff;
    }

    .kanban-card p {
      font-size: 0.75rem;
      margin: 0.15rem 0;
      color: #555;
    }

    @media (max-width: 768px) {
      .kanban-board {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body>

  <!-- Top bar -->
  <div class="kanban-topbar">
    <div class="kanban-title">
      <h1>Production Orders</h1>
    </div>
    <div class="kanban-actions">
      <%= link_to "Table",
            production_orders_path,
            class: "btn btn-outline-secondary btn-sm",
            data: { turbo: false } %>

      <%= link_to "New",
            new_production_order_path,
            class: "btn btn-primary btn-sm",
            data: { turbo: false } %>
    </div>
  </div>

  <!-- Status key -->
  <div class="status-legend">
    <span><span class="status-dot status-pending"></span> Pending</span>
    <span><span class="status-dot status-in_progress"></span> In Progress</span>
    <span><span class="status-dot status-completed"></span> Completed</span>
  </div>

  <!-- Filters -->
  <div class="kanban-controls">
    <%= form_with url: kanban_production_orders_path, method: :get, local: true do %>
      <div class="filters-row">
        <div class="form-group">
          <%= text_field_tag :search, @search_term, class: "form-control", placeholder: "Search order, customer, location" %>
        </div>
        <div class="form-group">
          <%= text_field_tag :location, @location, class: "form-control", placeholder: "Location" %>
        </div>
        <div class="form-group">
          <%= date_field_tag :due_from, @due_from, class: "form-control" %>
        </div>
        <div class="form-group">
          <%= date_field_tag :due_to, @due_to, class: "form-control" %>
        </div>
        <div class="form-group">
          <%= submit_tag "Apply", class: "btn btn-primary btn-sm" %>
          <%= link_to "Reset", kanban_production_orders_path, class: "btn btn-secondary btn-sm ms-1" %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Kanban board -->
  <div class="kanban-board">
    <% start_date = (@due_from.present? ? (Date.parse(@due_from) rescue nil) : nil) || Date.yesterday %>
    <% end_date   = (@due_to.present?   ? (Date.parse(@due_to)   rescue nil) : nil) || (Date.today + 6.days) %>
    <% if start_date > end_date %>
      <% start_date, end_date = end_date, start_date %>
    <% end %>

    <% (start_date..end_date).each do |date| %>
      <% orders_for_day = (@production_orders || ProductionOrder.none).where(due_date: date) %>

      <div class="kanban-column">
        <h2>
          <span><%= date.strftime("%a %m/%d") %></span>
          <span><%= orders_for_day.count %></span>
        </h2>

        <div class="kanban-cards">
          <% orders_for_day.each do |order| %>
            <%= link_to production_order_path(order), class: "kanban-card" do %>
              <div class="status-bar status-<%= order.status %>"></div>
              <h4>Order #<%= order.number.presence || order.id %></h4>
              <p><strong>Customer:</strong> <%= order.customer_name || "—" %></p>
              <p><strong>Location:</strong> <%= order.location_name || "—" %></p>
              <p><strong>Status:</strong> <%= order.status.titleize %></p>
              <% if order.priority.present? %>
                <p><strong>Priority:</strong> P<%= order.priority %></p>
              <% end %>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

</body>
</html>
