<head>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>

<%= form_with model: @production_order, local: true do |f| %>
  <% if @production_order.errors.any? %>
    <div class="alert alert-danger">
      <strong><%= pluralize(@production_order.errors.count, "error") %> prevented saving:</strong>
      <ul class="mb-0">
        <% @production_order.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <style>
    /* Tighter, cleaner spacing */
    .po-card .card-body { padding: 1.25rem; }
    .po-card .form-label { margin-bottom: 0.35rem; }
    .po-card .row { --bs-gutter-y: 0.85rem; }

    /* Select2: fixed, clean width + Bootstrap-like */
    #product_search,
    #location_search,
    .select2-container { width: 320px !important; max-width: 100% !important; }

    .select2-container--default .select2-selection--single {
      height: calc(2.375rem + 2px);
      border: 1px solid #ced4da;
      border-radius: 0.375rem;
      display: flex;
      align-items: center;
      padding: 0.375rem 0.75rem;
      background: #fff;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
      padding-left: 0;
      line-height: 1.5;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: calc(2.375rem + 2px);
      right: 6px;
    }
    .select2-dropdown {
      width: auto !important;
      min-width: 320px !important;
    }

    /* Make header card look less bulky */
    .po-section-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #495057;
      margin: 0 0 0.75rem 0;
    }

    .batch-stack {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .batch-row {
      display: grid;
      grid-template-columns: 1fr 120px auto; /* batch # | qty | remove */
      gap: 0.5rem;
      align-items: center;
      width: 100%;
    }

    .batch-remove {
      display: flex;
      align-items: center;
      white-space: nowrap;
    }

    @media (max-width: 768px) {
      .batch-row {
        grid-template-columns: 1fr;
      }
    }

  </style>

  <!-- Order details -->
<div class="card mb-3 po-card">
  <div class="card-body">
    <div class="po-section-title">Order Details</div>

    <!-- Row 1: Item / Customer / Qty -->
    <div class="row g-3 align-items-end">
      <div class="col-md-4">
        <%= f.label :product_id, "Item", class: "form-label d-block" %>

        <input type="hidden"
               id="product_id"
               name="production_order[product_id]"
               value="<%= @production_order.product_id %>">

        <select id="product_search" class="form-select"></select>
      </div>

      <div class="col-md-4">
        <%= f.label :customer_id, "Customer", class: "form-label d-block" %>

        <input type="hidden"
               id="customer_id"
               name="production_order[customer_id]"
               value="<%= @production_order.customer_id %>">

        <select id="customer_search" class="form-select"></select>
      </div>

      <div class="col-md-4">
        <%= f.label :qty_to_make, "Qty to make", class: "form-label d-block" %>
        <%= f.number_field :qty_to_make, step: 0.001, class: "form-control" %>
      </div>
    </div>

    <!-- Row 2: Due / Production / Status -->
    <div class="row g-3 align-items-end mt-1">
      <div class="col-md-4">
        <%= f.label :due_date, "Due date", class: "form-label d-block" %>
        <%= f.date_field :due_date, class: "form-control" %>
      </div>

      <div class="col-md-4">
        <%= f.label :production_date, "Production date", class: "form-label d-block" %>
        <%= f.date_field :production_date, class: "form-control" %>
      </div>

      <div class="col-md-4">
        <%= f.label :status, "Status", class: "form-label d-block" %>
        <%= f.select :status,
              ProductionOrder::STATUSES.map { |s| [s.titleize, s] },
              {},
              class: "form-select" %>
      </div>
    </div>

    <!-- Row 3: Origin / Priority / PDI Batches -->
    <div class="row g-3 align-items-start mt-3 pt-1">
      <div class="col-md-4">
        <%= f.label :location_id, "Origin", class: "form-label d-block" %>

        <input type="hidden"
               id="location_id"
               name="production_order[location_id]"
               value="<%= @production_order.location_id %>">

        <select id="location_search" class="form-select"></select>
      </div>

      <div class="col-md-4">
        <%= f.label :priority, "Priority", class: "form-label d-block" %>
        <%= f.number_field :priority,
              class: "form-control",
              min: 1,
              max: 10,
              placeholder: "1 = highest" %>
      </div>

      <div class="col-md-4">
        <%= f.label :production_order_batches, "PDI Batches", class: "form-label d-block" %>

        <div id="batch-numbers" class="batch-stack">
          <%= f.fields_for :production_order_batches do |b| %>
            <div class="batch-row" data-batch-row="1">
              <%= b.text_field :batch_number,
                    class: "form-control",
                    placeholder: "Batch #" %>

              <%= b.number_field :quantity,
                    step: 0.001,
                    class: "form-control",
                    placeholder: "Qty" %>

              <% if b.object.persisted? %>
                <div class="form-check batch-remove">
                  <%= b.check_box :_destroy, class: "form-check-input" %>
                  <%= b.label :_destroy, "Remove", class: "form-check-label small ms-1" %>
                </div>
              <% else %>
                <div></div>
              <% end %>
            </div>
          <% end %>
        </div>

        <button type="button"
                class="btn btn-sm btn-outline-secondary mt-2"
                id="add-batch">
          + Add Batch
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Components -->
<div class="card mb-3 po-card">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Components and Qty</h5>

      <button type="button" class="btn btn-sm btn-outline-secondary" id="recalc-components">
        Recalculate from BOM
      </button>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Description</th>
            <th style="width: 140px;">Qty</th>
            <th style="width: 120px;">UOM</th>
          </tr>
        </thead>

        <tbody id="components-body" class="components-tbody">
          <%= f.fields_for :production_order_components do |c| %>
            <tr class="component-row">
              <td>
                <%= c.hidden_field :id if c.object&.persisted? %>
                <%= c.hidden_field :position, class: "component-position" %>
                <%= c.text_field :description, class: "form-control form-control-sm component-desc" %>
              </td>

              <td>
                <%= c.number_field :quantity, step: 0.001, class: "form-control form-control-sm component-qty" %>
              </td>

              <td>
                <%= c.text_field :uom, class: "form-control form-control-sm component-uom" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>


  <!-- Notes + completion -->
  <div class="card mb-3 po-card">
    <div class="card-body">
      <div class="po-section-title">Notes & Completion</div>

      <div class="mb-3">
        <%= f.label :production_notes, "Production Notes", class: "form-label d-block" %>
        <%= f.text_area :production_notes, rows: 4, class: "form-control" %>
      </div>

      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <%= f.label :date_started, "Date Started", class: "form-label d-block" %>
          <%= f.date_field :date_started, class: "form-control" %>
        </div>
        <div class="col-md-3">
          <%= f.label :date_completed, "Date Completed", class: "form-label d-block" %>
          <%= f.date_field :date_completed, class: "form-control" %>
        </div>
        <div class="col-md-3">
          <%= f.label :total_qty_produced, "Total Qty Produced", class: "form-label d-block" %>
          <%= f.number_field :total_qty_produced, step: 0.001, class: "form-control" %>
        </div>
        <div class="col-md-3">
          <%= f.label :filled_by, "Filled by", class: "form-label d-block" %>
          <%= f.text_field :filled_by, class: "form-control" %>
        </div>
      </div>

      <div class="row g-3 mt-1 align-items-end">
        <div class="col-md-6">
          <%= f.label :approved_by, "Approved by", class: "form-label d-block" %>
          <%= f.text_field :approved_by, class: "form-control" %>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-between">
    <%= link_to "Cancel", request.referer.presence || kanban_production_orders_path, class: "btn btn-outline-secondary" %>
    <%= f.submit (@production_order.persisted? ? "Save Changes" : "Create Order"), class: "btn btn-primary" %>
  </div>

 <script>
document.addEventListener("turbo:load", function () {
  if (!window.jQuery || !jQuery.fn.select2) return;

  function setupSelect2({ selectId, hiddenId, ajaxUrl, placeholder, prefillUrl, textFromJson }) {
    var $select = jQuery("#" + selectId);
    var hidden = document.getElementById(hiddenId);
    if (!$select.length || !hidden) return;

    // Turbo safety: destroy stale instances so init/prefill actually runs
    if ($select.data("select2")) {
      $select.select2("destroy");
      $select.off();
      $select.empty();
    }

    $select.select2({
      placeholder: placeholder,
      allowClear: true,
      width: "100%",
      minimumInputLength: 0,
      dropdownAutoWidth: false,
      ajax: {
        url: ajaxUrl,
        dataType: "json",
        delay: 200,
        data: function (params) { return { q: params.term || "" }; },
        processResults: function (data) {
          var rows = Array.isArray(data) ? data : (data.results || []);
          return {
            results: rows.map(function (r) {
              return { id: r.id, text: r.text || r.name || r.city_with_company || ("#" + r.id) };
            })
          };
        }
      }
    });

    // keep hidden input synced
    $select.on("change", function () {
      hidden.value = this.value || "";
    });

    // âœ… PREFILL: inject selected option so Select2 displays it
    var existingId = hidden.value;
    if (existingId) {
      fetch(prefillUrl(existingId), { headers: { "Accept": "application/json" } })
        .then(function (r) { return r.json(); })
        .then(function (obj) {
          var text = textFromJson(obj) || ("#" + obj.id);
          var option = new Option(text, obj.id, true, true);
          $select.append(option).trigger("change");
        })
        .catch(function (e) {
          console.warn("Prefill failed for", selectId, e);
        });
    }
  }

  setupSelect2({
    selectId: "product_search",
    hiddenId: "product_id",
    ajaxUrl: "/products/search",
    placeholder: "Search products...",
    prefillUrl: function (id) { return "/products/" + id + ".json"; },
    textFromJson: function (p) { return p.text || p.name; }
  });

  setupSelect2({
    selectId: "customer_search",
    hiddenId: "customer_id",
    ajaxUrl: "/customers/select2",
    placeholder: "Search customers...",
    prefillUrl: function (id) { return "/customers/" + id + ".json"; },
    textFromJson: function (c) { return c.text || c.name; }
  });

  setupSelect2({
    selectId: "location_search",
    hiddenId: "location_id",
    ajaxUrl: "/locations/select2",
    placeholder: "Search origin locations...",
    prefillUrl: function (id) { return "/locations/" + id + ".json"; },
    textFromJson: function (l) { return l.text || l.city_with_company || l.company_name || l.city; }
  });
});

// Turbo cache safety
document.addEventListener("turbo:before-cache", function () {
  if (!window.jQuery || !jQuery.fn.select2) return;
  ["#product_search", "#customer_search", "#location_search"].forEach(function (sel) {
    var $el = jQuery(sel);
    if ($el.length && $el.data("select2")) $el.select2("destroy");
  });
});
</script>



<% end %>

<script>
document.addEventListener("turbo:load", function () {
  var container = document.getElementById("batch-numbers");
  var addBtn = document.getElementById("add-batch");
  if (!container || !addBtn) return;

  // find next index based on existing inputs
  var index = container.querySelectorAll("[data-batch-row]").length;
  if (index === 0) {
    // fallback if you didn't add data-batch-row yet
    index = container.querySelectorAll('input[name*="[production_order_batches_attributes]"][name*="[batch_number]"]').length;
  }

  addBtn.addEventListener("click", function () {
    var html = `
      <div class="d-flex gap-2 mb-1 align-items-center" data-batch-row="1">
        <input class="form-control"
               placeholder="Batch #"
               type="text"
               name="production_order[production_order_batches_attributes][${index}][batch_number]"
               id="production_order_production_order_batches_attributes_${index}_batch_number" />

        <input class="form-control"
               placeholder="Qty"
               step="0.001"
               type="number"
               name="production_order[production_order_batches_attributes][${index}][quantity]"
               id="production_order_production_order_batches_attributes_${index}_quantity" />

        <input type="checkbox"
               name="production_order[production_order_batches_attributes][${index}][_destroy]"
               id="production_order_production_order_batches_attributes_${index}__destroy" />
        <small class="text-muted">Remove</small>
      </div>
    `;

    container.insertAdjacentHTML("beforeend", html);
    index += 1;
  });
});

</script>


<script>
document.addEventListener("turbo:load", function () {
  var productHidden = document.getElementById("product_id");
  var qtyInput = document.querySelector('input[name="production_order[qty_to_make]"]');
  var tbody = document.getElementById("components-body");
  var recalcBtn = document.getElementById("recalc-components");

  if (!productHidden || !qtyInput || !tbody || !recalcBtn) return;

  function escapeHtml(s) {
    return String(s || "").replace(/[&<>"']/g, function (c) {
      return ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" })[c];
    });
  }

  function toNum(v) {
    var n = parseFloat(v);
    return isNaN(n) ? 0 : n;
  }

  function setComponentsRows(components, qtyToMake) {
    tbody.innerHTML = "";

    components.forEach(function (comp, idx) {
      var required = (toNum(comp.quantity_per_unit) * toNum(qtyToMake));
      var position = idx + 1;

      tbody.insertAdjacentHTML("beforeend", `
        <tr class="component-row">
          <td>
            <input type="hidden"
                   name="production_order[production_order_components_attributes][${idx}][position]"
                   value="${position}"
                   class="component-position" />

            <input class="form-control form-control-sm component-desc"
                   type="text"
                   name="production_order[production_order_components_attributes][${idx}][description]"
                   value="${escapeHtml(comp.name || comp.description || "")}" />
          </td>

          <td>
            <input class="form-control form-control-sm component-qty"
                   step="0.001"
                   type="number"
                   name="production_order[production_order_components_attributes][${idx}][quantity]"
                   value="${required.toFixed(3)}" />
          </td>

          <td>
            <input class="form-control form-control-sm component-uom"
                   type="text"
                   name="production_order[production_order_components_attributes][${idx}][uom]"
                   value="${escapeHtml(comp.uom || "")}" />
          </td>
        </tr>
      `);
    });
  }

  async function fetchBom(productId) {
    var r = await fetch("/products/" + productId + "/bom", {
      headers: { "Accept": "application/json" }
    });
    if (!r.ok) throw new Error("BOM fetch failed");
    return await r.json();
  }

  async function recalc() {
    var productId = productHidden.value;
    var qtyToMake = qtyInput.value;

    if (!productId) return;

    try {
      var bom = await fetchBom(productId);
      setComponentsRows(bom.components || [], qtyToMake);
    } catch (e) {
      console.warn(e);
    }
  }

  recalcBtn.addEventListener("click", recalc);
});
</script>