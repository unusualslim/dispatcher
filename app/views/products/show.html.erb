<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="mb-0"><%= @product.name %></h1>
      <div class="text-muted small">Product ID: <%= @product.id %></div>
    </div>
    <%= link_to "Back", products_path, class: "btn btn-outline-secondary btn-sm" %>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="mb-3">Components (BOM)</h5>

      <%= form_with model: @product, local: true do |f| %>
        <% if @product.errors.any? %>
          <div class="alert alert-danger">
            <strong><%= pluralize(@product.errors.count, "error") %> prevented saving:</strong>
            <ul class="mb-0">
              <% @product.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div id="bom-rows" class="d-flex flex-column gap-2">
          <%= f.fields_for :product_components do |pc| %>
            <div class="d-flex gap-2 align-items-center" data-bom-row="1">
              <%= pc.hidden_field :id if pc.object&.persisted? %>

              <%= pc.collection_select :component_product_id,
                    Product.order(:name),
                    :id,
                    :name,
                    { include_blank: "Select component..." },
                    class: "form-select" %>

              <%= pc.number_field :quantity_per_unit,
                    step: 0.001,
                    class: "form-control",
                    placeholder: "Qty / unit" %>

              <%= pc.text_field :uom,
                    class: "form-control",
                    placeholder: "UOM (e.g. GAL)" %>

              <div class="form-check ms-1">
                <%= pc.check_box :_destroy, class: "form-check-input" %>
                <%= pc.label :_destroy, "Remove", class: "form-check-label small" %>
              </div>
            </div>
          <% end %>
        </div>

        <button type="button" class="btn btn-sm btn-outline-secondary mt-3" id="add-bom-row">
          + Add Component
        </button>

        <div class="mt-3">
          <%= f.submit "Save BOM", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener("turbo:load", function () {
  var container = document.getElementById("bom-rows");
  var addBtn = document.getElementById("add-bom-row");
  if (!container || !addBtn) return;

  var index = container.querySelectorAll("[data-bom-row]").length;
  if (index === 0) {
    index = container.querySelectorAll('select[name*="[product_components_attributes]"]').length;
  }

  addBtn.addEventListener("click", function () {
    var html = `
      <div class="d-flex gap-2 align-items-center" data-bom-row="1">
        <select class="form-select"
                name="product[product_components_attributes][${index}][component_product_id]">
          <option value="">Select component...</option>
          ${Array.from(document.querySelectorAll('#bom-rows select option'))
            .filter(o => o.value !== "")
            .map(o => `<option value="${o.value}">${o.textContent}</option>`)
            .join("")}
        </select>

        <input class="form-control"
               step="0.001"
               type="number"
               placeholder="Qty / unit"
               name="product[product_components_attributes][${index}][quantity_per_unit]" />

        <input class="form-control"
               type="text"
               placeholder="UOM (e.g. GAL)"
               name="product[product_components_attributes][${index}][uom]" />

        <div class="form-check ms-1">
          <input class="form-check-input"
                 type="checkbox"
                 name="product[product_components_attributes][${index}][_destroy]" />
          <label class="form-check-label small">Remove</label>
        </div>
      </div>
    `;

    container.insertAdjacentHTML("beforeend", html);
    index += 1;
  });
});
</script>